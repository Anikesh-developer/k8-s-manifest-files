# ---- Stage 1: Build the application ----
FROM gradle:8.5-jdk21 AS builder

# Set working directory inside container
WORKDIR /app

# Copy Gradle wrapper and build files first (to leverage caching)
COPY build.gradle settings.gradle gradlew /app/
COPY gradle /app/gradle

# Copy proto files (adjust path if needed)
COPY pb /app/pb

# Copy the source code
COPY src /app/src

#---- verifyGoogleJavaFormat is added bcz it was giviing error while compiling
#Execution failed for task ':verifyGoogleJavaFormat'.
#> Problems: syntax errors

# Pass protoSourceDir to Gradle to avoid null errors
RUN ./gradlew clean build -x test -x verifyGoogleJavaFormat --no-daemon \        
    -PprotoSourceDir=/app/pb

# ---- Stage 2: Run the application ----
FROM eclipse-temurin:21-jdk-jammy

WORKDIR /app

# Copy the built jar from the builder stage
COPY --from=builder /app/build/libs/*.jar app.jar

# Run the application
ENTRYPOINT ["java", "-jar", "app.jar"]
